(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const y={},L=h=>{const t=h.map(e=>new Promise((s,i)=>{const n=new Image;n.src=`assets/${e}`,n.onload=()=>{y[e]=n,s()},n.onerror=()=>{i(new Error(`Failed to load asset: ${e}`))}}));return Promise.all(t).then(()=>{})};class Y{constructor(t){this.ctx=t}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}drawImage(t,e,s,i){this.ctx.drawImage(t,e,s,i,i)}}class N{constructor(){this.keys=new Set,window.addEventListener("keydown",t=>{this.keys.add(t.key.toLowerCase())}),window.addEventListener("keyup",t=>{this.keys.delete(t.key.toLowerCase())})}isDown(t){return this.keys.has(t)}clear(){this.keys.clear()}}class k{constructor(t,e,s,i,n){this.image=t,this.frameWidth=e,this.frameHeight=s,this.frameCount=i,this.frameTime=n,this.currentFrame=0,this.currentTime=0}update(t){this.currentTime+=t,this.currentTime>=this.frameTime&&(this.currentTime=0,this.currentFrame=(this.currentFrame+1)%this.frameCount)}draw(t,e,s,i){t.drawImage(this.image,this.currentFrame*this.frameWidth,0,this.frameWidth,this.frameHeight,e,s,i,i)}reset(){this.currentFrame=0,this.currentTime=0}setImage(t){this.image=t,this.reset()}}class D{constructor(t,e,s){this.input=t,this.horseSound=e,this.soundtrack=s,this.x=0,this.y=0,this.speed=600,this.soundtrackStarted=!1,this.direction="right",this.isMoving=!1,this.inputEnabled=!0,this.animations={walk:{left:new k(y["walk_left.png"]??(()=>{throw new Error("Missing asset: walk_left.png")})(),64,64,4,.15),right:new k(y["walk_right.png"]??(()=>{throw new Error("Missing asset: walk_right.png")})(),64,64,4,.15),up:new k(y["walk_up.png"]??(()=>{throw new Error("Missing asset: walk_up.png")})(),64,64,4,.15),down:new k(y["walk_down.png"]??(()=>{throw new Error("Missing asset: walk_down.png")})(),64,64,4,.15)},idle:{left:new k(y["idle_left.png"]??(()=>{throw new Error("Missing asset: idle_left.png")})(),64,64,4,.4),right:new k(y["idle_right.png"]??(()=>{throw new Error("Missing asset: idle_right.png")})(),64,64,4,.4)}},this.currentAnimator=this.animations.idle.right}setInputEnabled(t){this.inputEnabled=t}update(t){const e=this.inputEnabled?{up:this.input.isDown("w"),down:this.input.isDown("s"),left:this.input.isDown("a"),right:this.input.isDown("d")}:{up:!1,down:!1,left:!1,right:!1},s=this.isMoving;this.isMoving=Object.values(e).some(Boolean),!this.soundtrackStarted&&this.isMoving&&(this.soundtrack.play().catch(i=>console.warn("Blocked soundtrack:",i)),this.soundtrackStarted=!0),this.isMoving&&!s?(this.horseSound.currentTime=0,this.horseSound.play()):!this.isMoving&&s&&this.horseSound.pause(),e.up?(this.y-=this.speed*t,this.direction="up"):e.down?(this.y+=this.speed*t,this.direction="down"):e.left?(this.x-=this.speed*t,this.direction="left"):e.right&&(this.x+=this.speed*t,this.direction="right"),this.isMoving?(this.currentAnimator=this.animations.walk[this.direction],this.currentAnimator.update(t)):(this.direction==="left"||this.direction==="right")&&(this.currentAnimator=this.animations.idle[this.direction],this.currentAnimator.update(t))}render(t,e,s){this.currentAnimator.draw(t,e,s,264)}}class x{constructor(t,e,s,i,n,o,a=.15,r="NPC",l){this.worldX=e,this.worldY=s,this.name=r,this.animator=new k(t,i,n,o,a),l&&(this.audio=new Audio(l),this.audio.loop=!0,this.audio.volume=0)}update(t){this.animator.update(t)}render(t,e,s,i){const n=this.worldX-e,o=this.worldY-s;this.animator.draw(t,n,o,i)}}class X{constructor(t){this.jsonPath=t,this.data={}}async load(){const t=await fetch(this.jsonPath);if(!t.ok)throw new Error("Failed to load NPC quotes");this.data=await t.json()}getRandomQuote(){const t=Object.keys(this.data);if(t.length===0)return"";const e=t[Math.floor(Math.random()*t.length)];if(!e||!this.data[e]||this.data[e].length===0)return"";const s=this.data[e];return s[Math.floor(Math.random()*s.length)]??""}getComposedQuote(t=2){if(Object.keys(this.data).length===0)return"";const e=[];for(let s=0;s<t;s++){const i=Object.keys(this.data),n=i[Math.floor(Math.random()*i.length)];if(!n||!this.data[n]||this.data[n].length===0)continue;const o=this.data[n],a=o[Math.floor(Math.random()*o.length)]??"";e.push(this.trimToSegment(a))}return e.join(" ")}trimToSegment(t){const e=t.split(" "),s=Math.floor(Math.random()*Math.max(1,e.length-4)),i=Math.min(e.length,s+Math.floor(4+Math.random()*5));return e.slice(s,i).join(" ")}}class O{constructor(){this.id="dancer",this.state="intro"}start(){this.state}respond(t,e){const s=t.toLowerCase();switch(this.state){case"intro":{const i=e.getComposedQuote(2);return this.state="hintNorth",`This world is a real mess. ${i}`}case"hintNorth":return P(s,["north","up"])?(this.state="hintRoot",`You may as well look north. ${e.getRandomQuote()}`):`Directions matter. ${e.getComposedQuote(2)}`;case"hintRoot":return P(s,["tree","root","trees","roots","plants","plant"])?(this.state="request",`It will look like someone walked. A root. ${e.getComposedQuote(2)}`):`Look for signs in the ground. ${e.getRandomQuote()}`;case"request":return P(s,["ok","okay","yes","sure","i will","accept"])?(this.state="accepted",`It's beautiful. ${e.getComposedQuote(2)}`):`You've certainly changed. I haven't. go north, take the root. ${e.getRandomQuote()}`;case"accepted":return this.state="complete",`Just one way, in and back out. ${e.getComposedQuote(2)}`;case"complete":return"Let´s see what it remembers."}}}const P=(h,t)=>t.some(e=>h.includes(e));class _{constructor(t){this.activeNPC=null,this.conversationHistory=[],this.brains=new Map,this.composer=new X(t),this.brains.set("dancer",new O)}async load(){await this.composer.load()}startConversation(t){this.activeNPC=t,this.conversationHistory=[],this.brains.get(t)?.start()}endConversation(){this.activeNPC=null,this.conversationHistory=[]}getNPCResponse(t){if(!this.activeNPC)throw new Error("No NPC conversation started.");let e;const s=this.brains.get(this.activeNPC);return s?e=s.respond(t,this.composer):e=Math.random()>.5?this.composer.getComposedQuote(2+Math.floor(Math.random()*2)):this.composer.getRandomQuote(),this.conversationHistory.push(`Player: ${t}`),this.conversationHistory.push(`${this.activeNPC}: ${e}`),e}getHistory(){return[...this.conversationHistory]}}class ${constructor(t){this.input=t,this.active=!1,this.npcName="",this.rawText="",this.pages=[],this.pageIndex=0,this.revealChars=0,this.charsPerSecond=55,this.lineHeight=28,this.padding=22,this.boxHeight=156,this.textTopGap=10,this.font="16px 'Public Pixel', sans-serif",this.nameFont="bold 16px 'Public Pixel', sans-serif",this.inputFont="bold 16px 'Public Pixel', sans-serif",this.typingMode=!1,this.typedText="",this.submitted=null,this.handleTyping=e=>{if(this.typingMode){if((e.key==="Backspace"||e.key==="Enter"||e.key===" ")&&e.preventDefault(),e.key==="Backspace"){this.typedText=this.typedText.slice(0,-1);return}if(e.key==="Enter"){this.submitted=this.typedText.trim(),this.disableTyping();return}if(e.key===" "){this.typedText+=" ";return}e.key.length===1&&(this.typedText+=e.key)}}}open(t,e){this.active=!0,this.npcName=t,this.rawText=e,this.pages=[],this.pageIndex=0,this.revealChars=0}close(){this.active=!1}isActive(){return this.active}isTyping(){return this.typingMode}pollSubmittedText(){const t=this.submitted;return this.submitted=null,t}update(t){if(!this.active||this.typingMode)return;if(this.revealChars+=this.charsPerSecond*t,this.input.isDown(" ")||this.input.isDown("Enter")||this.input.isDown("z")){const s=this.currentPageFullText().length;this.revealChars<s?this.revealChars=s:this.pageIndex<this.pages.length-1?(this.pageIndex++,this.revealChars=0):this.close()}}enableTyping(){this.typingMode=!0,this.typedText="",window.addEventListener("keydown",this.handleTyping)}disableTyping(){this.typingMode=!1,window.removeEventListener("keydown",this.handleTyping)}getTypedText(){return this.typedText}render(t,e,s){if(!this.active){this.typingMode&&(t.save(),t.globalAlpha=1,t.fillStyle="#222",t.fillRect(50,s-80,e-100,40),t.strokeStyle="#fff",t.strokeRect(50,s-80,e-100,40),t.fillStyle="#fff",t.font=this.inputFont,t.textBaseline="middle",t.fillText(this.typedText+"_",60,s-60),t.restore());return}this.pages.length===0&&this.computePages(t,e);const i=this.padding,n=e-this.padding*2,o=this.boxHeight,a=s-o-this.padding;t.save(),t.globalAlpha=.9,t.fillStyle="#111",this.roundRect(t,i,a,n,o,10),t.fill(),t.globalAlpha=1,t.strokeStyle="#ffffff55",t.lineWidth=2,this.roundRect(t,i,a,n,o,10),t.stroke(),t.font=this.nameFont,t.fillStyle="#fff",t.fillText(this.npcName,i+14,a+8+14);const d=i+this.padding,c=a+this.padding+24+this.textTopGap;t.font=this.font,t.fillStyle="#eee";const u=this.pages[this.pageIndex];if(u){const f=u.text.slice(0,Math.floor(this.revealChars));let v=0,m=c;for(const w of u.lines){const M=Math.max(0,Math.min(w.length,f.length-v)),F=w.slice(0,M);t.fillText(F,d,m),v+=w.length+1,m+=this.lineHeight}const g=u.text.length;if(this.revealChars>=g){const M=this.pageIndex<this.pages.length-1?"▶":"■";t.globalAlpha=.85,t.fillText(M,i+n-24,a+o-12),t.globalAlpha=1}}t.restore(),this.typingMode&&(t.save(),t.globalAlpha=1,t.fillStyle="#222",t.fillRect(50,s-80,e-100,40),t.strokeStyle="#fff",t.strokeRect(50,s-80,e-100,40),t.fillStyle="#fff",t.font=this.inputFont,t.textBaseline="middle",t.fillText(this.typedText+"_",60,s-60),t.restore())}currentPageFullText(){if(!this.pages.length||!this.pages[this.pageIndex])return"";const t=this.pages[this.pageIndex];return t?t.text:""}computePages(t,e){t.save(),t.font=this.font;const i=e-this.padding*2-this.padding*2,n=this.boxHeight-this.padding*2-24,o=Math.max(1,Math.floor(n/this.lineHeight)),a=this.rawText.split(/\s+/),r=[];let l="";for(const c of a){const u=l?l+" "+c:c;t.measureText(u).width<=i?l=u:(l&&r.push(l),l=c)}l&&r.push(l);const d=[];for(let c=0;c<r.length;c+=o){const u=r.slice(c,c+o);d.push({lines:u,text:u.join(`
`)})}this.pages=d.length?d:[{lines:[""],text:""}],t.restore()}roundRect(t,e,s,i,n,o){t.beginPath(),t.moveTo(e+o,s),t.arcTo(e+i,s,e+i,s+n,o),t.arcTo(e+i,s+n,e,s+n,o),t.arcTo(e,s+n,e,s,o),t.arcTo(e,s,e+i,s,o),t.closePath()}}class R{constructor(t,e,s,i,n=.3){this.tileName=t;const o=y[t];if(!o)throw new Error(`Missing animated tile: ${t}`);this.animator=new k(o,e,s,i,n)}update(t){this.animator.update(t)}render(t,e,s,i){this.animator.draw(t,e,s,i)}}const W=async h=>{const t=await fetch(h);if(!t.ok)throw new Error(`Failed to load world map from ${h}: ${t.statusText}`);const e=await t.json(),s=e.rows??[];if(!s.length)throw new Error(`World map at ${h} has no rows`);const i=s[0]?.length??0;if(i===0)throw new Error(`World map at ${h} has empty first row`);if(!s.every(n=>n.length===i))throw new Error(`World map at ${h} has rows of varying lengths`);return{legend:e.legend??{},rows:s,width:i,height:s.length}},T=(h,t,e)=>{if(e<0||e>=h.height||t<0||t>=h.width)return null;const s=h.rows[e];return typeof s>"u"||typeof s[t]>"u"?null:s[t]};class j{constructor(t,e,s,i,n,o=64,a=64,r=.08){this.id=t,this.tileX=e,this.tileY=s,this.collected=!1;const l=y[i];if(!l)throw new Error(`Pickup sprite missing: ${i}`);this.animator=new k(l,o,a,n,r)}update(t){this.collected||this.animator.update(t)}render(t,e,s,i){if(this.collected)return;const n=this.tileX*i-e,o=this.tileY*i-s;this.animator.draw(t,n,o,i)}isAt(t,e){return!this.collected&&this.tileX===t&&this.tileY===e}collect(){this.collected=!0}}const b=[],H=h=>Promise.all(h.map(t=>new Promise((e,s)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{b.push(i),e()},i.onerror=()=>s(new Error(`Failed to load image: ${t}`)),i.src=t}))).then(()=>{}),C=(h=164)=>{const t=document.createElement("canvas");t.width=h,t.height=h;const e=t.getContext("2d");for(let s=0;s<6;s++){const i=b[Math.floor(Math.random()*b.length)];if(!i)continue;const n=h/2,o=h/2,a=Math.floor(Math.random()*(i.width-n)),r=Math.floor(Math.random()*(i.height-o)),l=s%2*(h/2),d=Math.floor(s/2)*(h/2);e.drawImage(i,a,r,n,o,l,d,n,o)}return t},p=164;class U{constructor(t,e,s,i){this.input=t,this.horseSound=e,this.soundtrack=s,this.world=i,this.mapSeed=1337,this.wallMask=new Map,this.collageTex=C(p),this.collageTimer=0,this.pickups=[],this.inventory=new Set,this.ducks=[],this.frozenPos=null,this.prevDialogueActive=!1,this.playerX=0,this.playerY=0,this.grassTiles=["1.png","2.png","3.png","4.png"],this.tileCache=new Map,this.tileLifetime=3e3,this.lastTileX=0,this.lastTileY=0,this.currentNpcName=null,this.animatedTiles=new Map,this.SPEED=200,this.player=new D(this.input,this.horseSound,this.soundtrack);const n=y["duck.png"];if(!n)throw new Error("Duck asset 'duck.png' not found in assets.");this.ducks.push(new x(n,1e3,1e3,64,64,4,.25,"animal","assets/duck.mp3"));const o=y["dancer.png"];if(!o)throw new Error("Dancer asset 'dancer.png' not found in assets.");this.ducks.push(new x(o,500,500,64,64,14,.25,"dancer","assets/dancer.mp3")),this.dialogueUI=new $(this.input),this.dialogueManager=new _("assets/npcQuotes.json"),this.dialogueManager.load().catch(a=>{throw new Error(`Failed to load NPC dialogues: ${a}`)}),this.pickups.push(new j("root",2,2,"root.png",26,64,64,.08))}hashTile(t,e){const s=t|0,i=e|0;let n=s*374761393+i*668265263+this.mapSeed*1442695040>>>0;return n^=n<<13,n>>>=0,n^=n>>17,n>>>=0,n^=n<<5,n>>>=0,(n>>>0)/4294967295}isWallAt(t,e){const s=`${t},${e}`,i=this.wallMask.get(s);if(i!==void 0)return i;const n=T(this.world,t,e);if(n==="W"||n==="C")return this.wallMask.set(s,!1),!1;const a=this.hashTile(t,e)<.12;return this.wallMask.set(s,a),a}updatePickups(t){for(const e of this.pickups)e.update(t)}tryCollectPickup(){if(!this.input.isDown("f"))return;const t=this.playerX,e=this.playerY,s=p*10;for(const i of this.pickups){const n=i.tileX*p+p/2,o=i.tileY*p+p/2,a=n-t,r=o-e;if(Math.sqrt(a*a+r*r)<s){i.collect(),this.inventory.add(i.id);break}}}collidesWithPickup(t,e){return this.pickups.some(s=>s.isAt(t,e))}isWalkableTile(t,e){const s=T(this.world,t,e);return s==="W"||s==="C"?!0:!this.isWallAt(t,e)}collidesWithNPC(t,e){return this.ducks.some(s=>{const i=Math.floor(s.worldX/p),n=Math.floor(s.worldY/p);return i===t&&n===e})}setFaceOverlay(t){this.face=t}getTile(t,e){const s=`${t},${e}`,i=performance.now(),n=this.tileCache.get(s);if(n&&i-n.time<this.tileLifetime)return n.tile;let o;const a=T(this.world,t,e);if(a==="W")this.animatedTiles.has(s)||this.animatedTiles.set(s,new R("water.jpg",64,64,10,.15)),o=this.animatedTiles.get(s);else if(a==="G"||a===null)if(this.isWallAt(t,e))o="4.png";else{const r=["1.png","2.png","3.png"];o=r[Math.floor(Math.random()*r.length)]??"1.png"}else o=["1.png","2.png","3.png"][Math.floor(Math.random()*3)]??"1.png";return this.tileCache.set(s,{tile:o,time:i}),o}update(t){this.collageTimer+=t,this.collageTimer>2&&(this.collageTex=C(p),this.collageTimer=0);for(const o of this.animatedTiles.values())o.update(t);this.updatePickups(t);const e=this.dialogueUI.isActive();if(e&&this.frozenPos&&(this.playerX=this.frozenPos.x,this.playerY=this.frozenPos.y),this.player.setInputEnabled(!e),e){this.dialogueUI.update(t);const o=this.dialogueUI.pollSubmittedText();if(o){const a=this.dialogueManager.getNPCResponse(o),r=this.currentNpcName??"NPC";this.dialogueUI.open(r,a)}}else{const o=this.SPEED*t;let a=0,r=0;if(this.input.isDown("a")&&(a-=o),this.input.isDown("d")&&(a+=o),this.input.isDown("w")&&(r-=o),this.input.isDown("s")&&(r+=o),a!==0){const l=this.playerX+a,{cx:d,cy:c}=this.getPlayerCenterTile(l,this.playerY);this.isWalkableTile(d,c)&&!this.collidesWithNPC(d,c)&&!this.collidesWithPickup(d,c)&&(this.playerX=l)}if(r!==0){const l=this.playerY+r,{cx:d,cy:c}=this.getPlayerCenterTile(this.playerX,l);this.isWalkableTile(d,c)&&!this.collidesWithNPC(d,c)&&!this.collidesWithPickup(d,c)&&(this.playerY=l)}this.checkNPCInteraction()}this.tryCollectPickup();const s=Math.floor(this.playerX/p),i=Math.floor(this.playerY/p);(s!==this.lastTileX||i!==this.lastTileY)&&(this.onTileChanged(s,i),this.lastTileX=s,this.lastTileY=i),this.player.update(t),this.ducks.forEach(o=>o.update(t));for(const o of this.ducks){if(!o.audio)continue;const a=o.worldX-this.playerX,r=o.worldY-this.playerY,l=Math.sqrt(a*a+r*r),d=300;let c=0;l<d&&(c=1-l/d),c>0&&o.audio.paused?o.audio.play().catch(u=>console.warn("Audio blocked:",u)):c<=0&&!o.audio.paused&&o.audio.pause(),o.audio.volume+=(c-o.audio.volume)*.1}const n=this.dialogueUI.isActive();!this.prevDialogueActive&&n?this.face?.show():this.prevDialogueActive&&!n&&(this.face?.hide(),this.dialogueUI.disableTyping(),this.frozenPos=null,this.input.clear?.()),this.prevDialogueActive=n}checkNPCInteraction(){if(!this.input.isDown("e"))return;const t=100;let e=null,s=1/0;for(const i of this.ducks){const n=i.worldX-this.playerX,o=i.worldY-this.playerY,a=n*n+o*o;a<t*t&&a<s&&(e=i,s=a)}e&&this.startTalk(e.name)}onTileChanged(t,e){for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){const n=`${t+i},${e+s}`;this.tileCache.delete(n)}}render(t){const e=window.innerWidth,s=window.innerHeight,i=this.playerX-e/2,n=this.playerY-s/2,o=Math.floor(i/p)-1,a=Math.floor(n/p)-1,r=Math.ceil((i+e)/p)+1,l=Math.ceil((n+s)/p)+1;for(let u=a;u<l;u++)for(let f=o;f<r;f++){const v=f*p-i,m=u*p-n;if(T(this.world,f,u)==="C"){t.ctx.drawImage(this.collageTex,v,m,p,p);continue}const g=this.getTile(f,u);if(g)if(typeof g=="string"){const w=y[g];w&&t.drawImage(w,v,m,p)}else g.render(t.ctx,v,m,p)}for(const u of this.pickups)u.render(t.ctx,i,n,p);const d=e/2-32,c=s/2-32;this.player.render(t.ctx,d,c),this.ducks.forEach(u=>{u.render(t.ctx,i,n,p)}),this.dialogueUI.render(t.ctx,e,s)}getPlayerCenterTile(t=this.playerX,e=this.playerY){const s=Math.floor((t+p/2)/p),i=Math.floor((e+p/2)/p);return{cx:s,cy:i}}startTalk(t){this.currentNpcName=t,this.frozenPos={x:this.playerX,y:this.playerY},this.dialogueManager.startConversation(t),this.dialogueUI.open("You",""),this.dialogueUI.enableTyping(),this.input.clear?.()}}class q{constructor(t,e,s,i){this.canvas=t,this.horseSound=e,this.soundtrack=s,this.world=i,this.lastTime=0,this.ctx=t.getContext("2d"),this.renderer=new Y(this.ctx),this.input=new N,this.scene=new U(this.input,this.horseSound,this.soundtrack,this.world),window.addEventListener("resize",()=>this.resize()),this.resize()}setFaceOverlay(t){this.scene?.setFaceOverlay?.(t)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}start(){requestAnimationFrame(this.loop.bind(this))}loop(t){const e=(t-this.lastTime)/1e3;this.lastTime=t,this.scene.update(e),this.renderer.clear(),this.scene.render(this.renderer),requestAnimationFrame(this.loop.bind(this))}}const Q="modulepreload",B=function(h){return"/"+h},I={},V=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let l=function(d){return Promise.all(d.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};var o=l;document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");i=l(e.map(d=>{if(d=B(d),d in I)return;I[d]=!0;const c=d.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":Q,c||(f.as="script"),f.crossOrigin="",f.href=d,r&&f.setAttribute("nonce",r),document.head.appendChild(f),c)return new Promise((v,m)=>{f.addEventListener("load",v),f.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${d}`)))})}))}function n(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&n(r.reason);return t().catch(n)})};class z{constructor(t="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task"){this.modelUrl=t,this.maskAnimator=null,this.eyeLeftOuter=33,this.eyeRightOuter=263,this.smoothed={cx:0,cy:0,scale:0,angle:0,ready:!1},this.smoothFactor=.25,this.holdFramesLeft=0,this.maskScale=2.8,this.maskYOffset=-.15,this.maskXOffsetPx=0,this.maxHoldFrames=6,this.running=!1,this.rafId=null,this.lastVideoTime=-1,this.frameSkip=0,this.detectEveryNFrames=1,this.landmarker=null,this.maskImage=new Image,this.maskLoaded=!1,this.initialized=!1,this.loop=()=>{if(!this.running)return;this.context.save(),this.context.translate(this.canvas.width,0),this.context.scale(-1,1),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.video,0,0,this.canvas.width,this.canvas.height);const o=this.video.currentTime;if(this.landmarker&&o!==this.lastVideoTime){if(this.frameSkip=(this.frameSkip+1)%this.detectEveryNFrames,this.frameSkip===0){const r=this.landmarker.detectForVideo(this.video,performance.now())?.faceLandmarks?.[0];r?(this.updatePoseFromLandmarks(r),this.holdFramesLeft=this.maxHoldFrames):this.holdFramesLeft>0&&this.holdFramesLeft--}this.lastVideoTime=o}this.smoothed.ready&&this.holdFramesLeft>0&&this.drawSmoothedMask(),this.maskAnimator&&(this.maskAnimator.update(1/60),this.drawMaskFromAnimator()),this.context.restore(),this.rafId=requestAnimationFrame(this.loop)};const e=document.querySelector(".face-overlay"),s=document.getElementById("faceCanvas");if(!e||!s)throw new Error("Overlay or canvas element not found (need .face-overlay and #faceCanvas)");this.overlayElement=e,this.canvas=s;const i=this.canvas.getContext("2d");if(!i)throw new Error("Failed to get canvas 2D context");this.context=i,this.video=document.createElement("video"),this.video.playsInline=!0,this.video.muted=!0,this.video.autoplay=!0;const n=new Image;n.src="assets/clown.png",n.onload=()=>{this.maskAnimator=new k(n,128,128,6,.3)}}async init(){if(this.initialized)return;let t,e;try{({FaceLandmarker:t,FilesetResolver:e}=await V(()=>import("./vision_bundle-BeL3EydY.js"),[]))}catch{throw new Error("Failed to load @mediapipe/tasks-vision. Is it installed?")}const s=await e.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.4/wasm");this.landmarker=await t.createFromOptions(s,{baseOptions:{modelAssetPath:this.modelUrl},runningMode:"VIDEO",numFaces:1});let i;this.canvas.width=160,this.canvas.height=120;try{i=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:128},height:{ideal:96},facingMode:"user"},audio:!1})}catch(n){throw n?.name==="NotAllowedError"?new Error("Camera permission was denied."):new Error("Unable to access camera.")}this.video.srcObject=i,await new Promise(n=>{const o=()=>{this.video.removeEventListener("loadedmetadata",o),n()};this.video.readyState>=1?n():this.video.addEventListener("loadedmetadata",o)});try{await this.video.play()}catch{throw new Error("Failed to start video playback (user gesture may be required).")}this.initialized=!0}async show(){await this.init(),this.overlayElement.style.display="block",this.running||(this.running=!0,this.lastVideoTime=-1,this.loop())}hide(){this.overlayElement.style.display="none",this.running=!1,this.rafId!=null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}async destroy(){this.hide(),this.video.srcObject?.getTracks().forEach(e=>e.stop()),this.video.srcObject=null,this.landmarker?.close?.(),this.landmarker=null,this.initialized=!1}drawMaskFromAnimator(){if(!this.maskAnimator)return;const{cx:t,cy:e,scale:s,angle:i}=this.smoothed,o=this.canvas.width-t+this.maskXOffsetPx,a=-i;this.context.save(),this.context.translate(o,e),this.context.rotate(a),this.maskAnimator.draw(this.context,-s/2,-s/2,s),this.context.restore()}updatePoseFromLandmarks(t){const e=this.canvas.width,s=this.canvas.height,i=t[this.eyeLeftOuter],n=t[this.eyeRightOuter];if(!i||!n)return;const o=i.x*e,a=i.y*s,r=n.x*e,l=n.y*s,d=(o+r)*.5,c=(a+l)*.5,u=Math.atan2(l-a,r-o),f=Math.hypot(r-o,l-a),v=f*2,m={cx:d,cy:c+this.maskYOffset*v,scale:this.maskScale*f,angle:u};if(!this.smoothed.ready)this.smoothed={...m,ready:!0};else{const g=this.smoothFactor,w=1-g;this.smoothed.cx=g*m.cx+w*this.smoothed.cx,this.smoothed.cy=g*m.cy+w*this.smoothed.cy,this.smoothed.scale=g*m.scale+w*this.smoothed.scale,this.smoothed.angle=g*m.angle+w*this.smoothed.angle}}drawSmoothedMask(){if(!this.maskLoaded)return;const t=this.canvas.width,{cx:e,cy:s,scale:i,angle:n}=this.smoothed,o=t-e+this.maskXOffsetPx,a=-n;this.context.save(),this.context.translate(o,s),this.context.rotate(a);const r=i,l=i;this.context.drawImage(this.maskImage,-r/2,-l/2,r,l),this.context.restore()}}const G=async()=>{const h=await fetch("assets/collage.json");if(!h.ok)throw new Error(`Failed to load collage.json: ${h.statusText}`);const t=await h.json();await H(t.images)},E=new z,S=new Audio("assets/horsEren.mp3");S.loop=!0;const A=new Audio("assets/Sima.mp3");A.loop=!0;const J=["1.png","2.png","3.png","4.png","walk_right.png","walk_left.png","walk_up.png","walk_down.png","idle_right.png","idle_left.png","duck.png","dancer.png","clown.png","water.jpg","root.png"];window.addEventListener("load",async()=>{await L(J),await G();const h=await W("assets/world.json"),t=document.getElementById("gameCanvas"),e=new q(t,S,A,h);e.setFaceOverlay(E);const s=()=>{E.init().catch(console.warn),window.removeEventListener("click",s),window.removeEventListener("keydown",s)};window.addEventListener("click",s),window.addEventListener("keydown",s),e.start(),window.face=E});
//# sourceMappingURL=index-efsz8B3N.js.map
